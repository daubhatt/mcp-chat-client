<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conversation Banking - Viom Technologies</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .viom-gradient {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 25%, #06b6d4 50%, #0891b2 75%, #0e7490 100%);
        }
        .viom-logo-bg {
            background: linear-gradient(45deg, #1e40af, #3b82f6);
            background-image: url('/static/images/viom-logo.png');
            background-size: 130%;
            background-repeat: no-repeat;
            background-position: center;
        }
        .viom-logo-bg-text {
            background: linear-gradient(45deg, #1e40af, #3b82f6);
        }
        .chat-container {
            height: calc(100vh - 2rem);
        }
        .messages-container {
            height: calc(100% - 140px);
        }
        .message-bubble {
            max-width: 80%;
            word-wrap: break-word;
        }
        .typing-indicator {
            animation: pulse 1.5s ease-in-out infinite;
        }
        .loading-dots {
            display: inline-block;
        }
        .loading-dots:after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }
        @keyframes dots {
            0%, 20% { color: rgba(0,0,0,0); text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0); }
            40% { color: black; text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0); }
            60% { text-shadow: .25em 0 0 black, .5em 0 0 rgba(0,0,0,0); }
            80%, 100% { text-shadow: .25em 0 0 black, .5em 0 0 black; }
        }
        .sidebar-transition {
            transition: transform 0.3s ease-in-out;
        }
        .conversation-item:hover {
            background-color: rgba(59, 130, 246, 0.1);
        }
        .message-content {
            white-space: pre-wrap;
        }
        .summary-card {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 50%, #06b6d4 100%);
        }
        .summary-stat {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        /* Mobile sidebar styles */
        @media (max-width: 1023px) {
            .sidebar-closed-mobile {
                width: 0 !important;
                min-width: 0 !important;
                overflow: hidden !important;
                transform: translateX(-100%);
            }
            .sidebar-open-mobile {
                transform: translateX(0);
            }
        }
        /* URL link styles */
        .message-content a {
            color: #3b82f6;
            text-decoration: underline;
        }
        .message-content a:hover {
            color: #1d4ed8;
        }
        /* Hide message input on summary page */
        .summary-mode .message-input-container {
            display: none !important;
        }
        .summary-mode .messages-container {
            height: calc(100% - 80px) !important;
        }
        .viom-accent {
            color: #06b6d4;
        }
        .viom-accent-bg {
            background-color: #06b6d4;
        }
        .feature-card {
            transition: all 0.3s ease;
        }
        .feature-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gray-50">
<div class="flex h-screen">
    <!-- Sidebar -->
    <div id="sidebar" class="bg-white shadow-2xl border-r border-gray-100 flex flex-col sidebar-transition sidebar-closed-mobile lg:w-80 lg:relative lg:z-auto fixed top-0 left-0 h-screen w-64 z-30">
        <!-- Header -->
        <div class="viom-gradient p-6 text-white">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 viom-logo-bg rounded-lg flex items-center justify-center backdrop-filter backdrop-blur-sm">
                        <!-- Logo will show as background image -->
                    </div>
                    <div>
                        <div class="font-bold text-lg" id="userDisplayName">Banking Assistant</div>
                        <div class="text-blue-100 text-sm">Viom Technologies</div>
                    </div>
                </div>
                <button id="logoutBtn" class="text-white hover:text-blue-200 transition duration-200 p-2 rounded-lg hover:bg-white hover:bg-opacity-10">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>

            <!-- Action Buttons -->
            <div class="space-y-3">
                <button id="newConversationBtn" class="w-full bg-white bg-opacity-20 text-white py-3 px-4 rounded-xl hover:bg-opacity-30 transition duration-200 flex items-center justify-center space-x-2 backdrop-filter backdrop-blur-sm">
                    <i class="fas fa-plus"></i>
                    <span>New Conversation</span>
                </button>

                <button id="backToDashboardBtn" class="w-full bg-white bg-opacity-10 text-white py-2 px-4 rounded-xl hover:bg-opacity-20 transition duration-200 flex items-center justify-center space-x-2" onclick="console.log('Dashboard sidebar clicked'); showSummaryView();">
                    <i class="fas fa-chart-pie"></i>
                    <span>Dashboard</span>
                </button>
            </div>
        </div>

        <!-- Conversations List -->
        <div class="flex-1 overflow-y-auto p-4">
            <h3 class="text-sm font-semibold text-gray-600 mb-4 flex items-center">
                <i class="fas fa-history mr-2 text-blue-600"></i>
                Recent Conversations
            </h3>
            <div id="conversationsList" class="space-y-2">
                <!-- Conversations will be loaded here -->
            </div>
        </div>

        <!-- Footer -->
        <div class="text-center">
            <div class="text-xs text-gray-500 mb-1">Powered by</div>
            <div class="text-xs font-semibold text-blue-600">Anthropic Claude AI</div>
            <div class="text-xs mt-1">
                <a href="https://www.viom.tech" target="_blank" class="text-blue-600 hover:text-blue-800 transition duration-200">Viom Tech</a>
            </div>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div id="mainChatArea" class="flex-1 flex flex-col chat-container w-full">
        <!-- Chat Header -->
        <div class="bg-white shadow-sm border-b border-gray-100 p-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <button id="sidebarToggle" class="lg:hidden text-gray-500 hover:text-gray-700 p-2 rounded-lg hover:bg-gray-100">
                        <i class="fas fa-bars"></i>
                    </button>

                    <!-- Back to Summary Button -->
                    <button id="backToSummaryBtn" class="hidden text-gray-500 hover:text-blue-600 p-2 rounded-lg hover:bg-blue-50 flex items-center space-x-2 transition duration-200" title="Back to Dashboard" onclick="console.log('Dashboard arrow clicked'); showSummaryView();">
                        <i class="fas fa-arrow-left"></i>
                        <span class="hidden sm:inline text-sm font-medium">Dashboard</span>
                    </button>

                    <!-- Viom Logo in Header -->
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 viom-logo-bg rounded-lg flex items-center justify-center">
                            <!-- Logo will show as background image -->
                        </div>
                        <div>
                            <h1 class="text-xl font-bold text-gray-800" id="conversationTitle">
                                Conversation Banking
                            </h1>
                            <div class="text-xs text-gray-500">Powered by AI • Viom Technologies</div>
                        </div>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <button id="deleteConversationBtn" class="hidden text-red-500 hover:text-red-700 p-2 rounded-lg hover:bg-red-50 transition duration-200">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Messages Area -->
        <div id="messagesContainer" class="flex-1 overflow-y-auto p-6 messages-container bg-gradient-to-b from-gray-50 to-white">
            <div id="messagesArea" class="space-y-6">
                <!-- Customer Summary (shown by default) -->
                <div id="customerSummaryMain" class="hidden">
                    <div class="max-w-6xl mx-auto">
                        <!-- Welcome Header -->
                        <div class="text-center mb-10">
                            <div class="w-24 h-24 viom-logo-bg rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-xl">
                                <!-- Logo will show as background image -->
                            </div>
                            <h2 class="text-4xl font-bold text-gray-800 mb-3" id="welcomeTitle">Welcome to Conversation Banking!</h2>
                            <p class="text-xl text-gray-600" id="welcomeSubtitle">Your AI-powered financial assistant dashboard</p>
                            <div class="text-sm text-blue-600 font-medium mt-2">
                                <i class="fas fa-shield-alt mr-1"></i>
                                Secured by Viom Technologies
                            </div>
                        </div>

                        <!-- AI Summary Card -->
                        <div id="aiSummaryCard" class="summary-card rounded-2xl p-8 text-white mb-8 shadow-2xl">
                            <div class="flex items-center space-x-3 mb-6">
                                <div class="w-12 h-12 bg-white bg-opacity-20 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-robot text-xl"></i>
                                </div>
                                <div>
                                    <span class="text-xl font-bold">AI Financial Assistant</span>
                                    <div class="text-blue-100 text-sm">Powered by Anthropic Claude</div>
                                </div>
                            </div>
                            <div id="aiSummaryMainContent" class="text-lg leading-relaxed">
                                <!-- AI-generated summary will be loaded here -->
                            </div>
                        </div>

                        <!-- Stats Grid -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                            <div class="feature-card bg-white rounded-xl shadow-lg border border-gray-100 p-6">
                                <div class="flex items-center space-x-4">
                                    <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                                        <i class="fas fa-comments text-blue-600 text-xl"></i>
                                    </div>
                                    <div>
                                        <div class="text-sm font-medium text-gray-500">Conversations</div>
                                        <div class="text-3xl font-bold text-gray-800" id="totalConversations">0</div>
                                    </div>
                                </div>
                            </div>
                            <div class="feature-card bg-white rounded-xl shadow-lg border border-gray-100 p-6">
                                <div class="flex items-center space-x-4">
                                    <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                                        <i class="fas fa-envelope text-green-600 text-xl"></i>
                                    </div>
                                    <div>
                                        <div class="text-sm font-medium text-gray-500">Total Messages</div>
                                        <div class="text-3xl font-bold text-gray-800" id="totalMessages">0</div>
                                    </div>
                                </div>
                            </div>
                            <div class="feature-card bg-white rounded-xl shadow-lg border border-gray-100 p-6">
                                <div class="flex items-center space-x-4">
                                    <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                                        <i class="fas fa-tools text-purple-600 text-xl"></i>
                                    </div>
                                    <div>
                                        <div class="text-sm font-medium text-gray-500">AI Tools</div>
                                        <div class="text-3xl font-bold text-gray-800" id="availableTools">0</div>
                                    </div>
                                </div>
                            </div>
                            <div class="feature-card bg-white rounded-xl shadow-lg border border-gray-100 p-6">
                                <div class="flex items-center space-x-4">
                                    <div class="w-12 h-12 bg-cyan-100 rounded-xl flex items-center justify-center">
                                        <i class="fas fa-calendar text-cyan-600 text-xl"></i>
                                    </div>
                                    <div>
                                        <div class="text-sm font-medium text-gray-500">Member Since</div>
                                        <div class="text-sm font-bold text-gray-800" id="memberSince">-</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Recent Activity -->
                        <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-8 mb-8">
                            <div class="flex items-center justify-between mb-6">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-clock text-blue-600"></i>
                                    </div>
                                    <div>
                                        <h3 class="text-xl font-bold text-gray-800">Recent Activity</h3>
                                        <div class="text-sm text-gray-500">Your latest banking interactions</div>
                                    </div>
                                </div>
                                <span class="text-sm text-gray-400 bg-gray-50 px-3 py-1 rounded-full" id="lastActiveTime">-</span>
                            </div>
                            <div id="recentActivity" class="space-y-4">
                                <!-- Recent conversations will be shown here -->
                            </div>
                        </div>

                        <!-- Technology Info -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                            <div class="bg-gradient-to-r from-blue-50 to-cyan-50 rounded-xl p-6 border border-blue-100">
                                <div class="flex items-center space-x-3 mb-3">
                                    <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-brain text-white"></i>
                                    </div>
                                    <h4 class="text-lg font-semibold text-gray-800">AI Technology</h4>
                                </div>
                                <p class="text-gray-600 text-sm leading-relaxed">
                                    Powered by Anthropic's Claude AI for intelligent, context-aware banking assistance with advanced reasoning capabilities.
                                </p>
                            </div>

                            <div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-xl p-6 border border-green-100">
                                <div class="flex items-center space-x-3 mb-3">
                                    <div class="w-10 h-10 bg-green-600 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-shield-alt text-white"></i>
                                    </div>
                                    <h4 class="text-lg font-semibold text-gray-800">Enterprise Security</h4>
                                </div>
                                <p class="text-gray-600 text-sm leading-relaxed">
                                    Built with Spring Boot and OAuth2 authentication, ensuring bank-grade security for all your financial interactions.
                                </p>
                            </div>
                        </div>

                        <!-- Call to Action -->
                        <div class="text-center">
                            <button id="startNewConversationBtn" class="bg-gradient-to-r from-blue-600 to-cyan-600 text-white px-10 py-4 rounded-xl hover:from-blue-700 hover:to-cyan-700 transition duration-300 flex items-center justify-center space-x-3 mx-auto shadow-lg text-lg font-semibold">
                                <i class="fas fa-comment-dots text-xl"></i>
                                <span>Start Banking Conversation</span>
                            </button>
                            <p class="text-gray-500 text-sm mt-3">Ask questions, get account info, or request financial assistance</p>
                        </div>
                    </div>
                </div>

                <!-- Default welcome message (fallback) -->
                <div id="defaultWelcome" class="flex justify-center">
                    <div class="text-center p-12">
                        <div class="w-20 h-20 viom-logo-bg rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg">
                            <!-- Logo will show as background image -->
                        </div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-3">Welcome to Conversation Banking!</h2>
                        <p class="text-gray-600 mb-6">Your AI-powered banking assistant by Viom Technologies</p>
                        <p class="text-sm text-blue-600">Start a conversation or select an existing one from the sidebar.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Typing Indicator -->
        <div id="typingIndicator" class="hidden px-6 py-3">
            <div class="flex items-center space-x-3 text-gray-500">
                <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-robot text-blue-600"></i>
                </div>
                <div class="bg-white rounded-2xl px-4 py-3 shadow-sm border border-gray-100">
                    <span class="typing-indicator">AI is thinking<span class="loading-dots"></span></span>
                </div>
            </div>
        </div>

        <!-- Message Input -->
        <div class="bg-white border-t border-gray-100 p-6 message-input-container">
            <form id="messageForm" class="flex space-x-4">
                <div class="flex-1 relative">
                    <textarea
                            id="messageInput"
                            placeholder="Ask about your accounts, request transfers, or get financial advice..."
                            class="w-full p-4 border-2 border-gray-200 rounded-xl resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 bg-gray-50 hover:bg-white"
                            rows="2"
                            maxlength="4000"
                    ></textarea>
                    <div id="charCounter" class="absolute bottom-2 right-3 text-xs text-gray-400 bg-white px-2 py-1 rounded">0/4000</div>
                </div>
                <button
                        type="submit"
                        id="sendButton"
                        class="bg-gradient-to-r from-blue-600 to-cyan-600 text-white px-8 py-4 rounded-xl hover:from-blue-700 hover:to-cyan-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200 flex items-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg"
                        disabled
                >
                    <i class="fas fa-paper-plane text-lg"></i>
                    <span class="hidden sm:inline font-medium">Send</span>
                </button>
            </form>

            <!-- Quick Actions -->
            <div class="mt-4 flex flex-wrap gap-2">
                <button class="quick-action bg-blue-50 text-blue-700 px-3 py-1 rounded-full text-sm hover:bg-blue-100 transition duration-200" data-message="Show me my account balance">
                    <i class="fas fa-wallet mr-1"></i>Account Balance
                </button>
                <button class="quick-action bg-green-50 text-green-700 px-3 py-1 rounded-full text-sm hover:bg-green-100 transition duration-200" data-message="Help me transfer money">
                    <i class="fas fa-exchange-alt mr-1"></i>Transfer Money
                </button>
                <button class="quick-action bg-purple-50 text-purple-700 px-3 py-1 rounded-full text-sm hover:bg-purple-100 transition duration-200" data-message="Show me recent transactions">
                    <i class="fas fa-history mr-1"></i>Recent Transactions
                </button>
                <button class="quick-action bg-orange-50 text-orange-700 px-3 py-1 rounded-full text-sm hover:bg-orange-100 transition duration-200" data-message="I need financial advice">
                    <i class="fas fa-chart-line mr-1"></i>Financial Advice
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Mobile sidebar overlay -->
<div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 lg:hidden hidden"></div>

<script>
    function getAuthHeaders() {
        const jwtToken = localStorage.getItem('jwtToken');
        const headers = {
            'Content-Type': 'application/json'
        };

        if (jwtToken) {
            headers['Authorization'] = `Bearer ${jwtToken}`;
        }

        return headers;
    }

    const API_BASE = '/api';
    let currentUser = null;
    let currentConversationId = null;
    let conversations = [];
    let isTyping = false;
    let isSummaryMode = true; // Track if we're in summary mode

    // Initialize the application
    document.addEventListener('DOMContentLoaded', function() {
        initializeApp();
    });

    async function initializeApp() {
        const userData = localStorage.getItem('currentUser');
        const jwtToken = localStorage.getItem('jwtToken');

        if (!userData || !jwtToken) {
            window.location.href = '/';
            return;
        }

        currentUser = JSON.parse(userData);

        // Extract user's display name for greeting
        const userName = currentUser.displayName || currentUser.customerId || 'User';
        document.getElementById('userDisplayName').textContent = userName;

        // Initialize with summary view
        showSummaryViewWithLoading();

        // Try to use cached session data first
        const cachedSession = getCachedSessionData();
        if (cachedSession) {
            console.log('Using cached session data');
            conversations = cachedSession.conversations || [];
            renderConversations();
            await loadCustomerSummary();
        } else {
            // Only call session API if no cached data is available
            console.log('Loading fresh session data');
            await loadUserSession();
            await loadCustomerSummary();
        }

        setupEventListeners();
        setupTextareaAutoResize();
        setupQuickActions();
        updateSidebarVisibility();
    }

    function setupQuickActions() {
        document.querySelectorAll('.quick-action').forEach(button => {
            button.addEventListener('click', function() {
                const message = this.dataset.message;
                document.getElementById('messageInput').value = message;
                handleInputChange({ target: document.getElementById('messageInput') });
            });
        });
    }

    async function loadUserSession() {
        try {
            const response = await fetch(`${API_BASE}/chat/session`, {
                headers: getAuthHeaders()
            });

            if (response.status === 401) {
                handleAuthError();
                return;
            }

            if (response.ok) {
                const sessionData = await response.json();
                conversations = sessionData.conversations || [];

                // Cache the session data
                storeSessionData(sessionData);

                renderConversations();
            } else {
                console.warn('Failed to load user session');
            }
        } catch (error) {
            console.error('Error loading user session:', error);
        }
    }

    async function refreshSessionData() {
        await loadUserSession();
    }

    function storeSessionData(sessionData) {
        localStorage.setItem('customerSession', JSON.stringify(sessionData));
        localStorage.setItem('sessionTimestamp', Date.now().toString());
    }

    function getCachedSessionData() {
        const sessionData = localStorage.getItem('customerSession');
        const timestamp = localStorage.getItem('sessionTimestamp');

        if (!sessionData || !timestamp) {
            return null;
        }

        // Check if session data is older than 5 minutes (300000 ms)
        const sessionAge = Date.now() - parseInt(timestamp);
        if (sessionAge > 300000) {
            // Session data is stale, remove it
            localStorage.removeItem('customerSession');
            localStorage.removeItem('sessionTimestamp');
            return null;
        }

        return JSON.parse(sessionData);
    }

    async function loadCustomerSummary() {
        console.log('Loading customer summary...');
        try {
            const response = await fetch(`${API_BASE}/chat/summary`, {
                headers: getAuthHeaders()
            });

            if (response.status === 401) {
                handleAuthError();
                return;
            }

            if (response.ok) {
                const summary = await response.json();
                console.log('Customer summary loaded successfully');

                setTimeout(() => {
                    renderCustomerSummaryMain(summary);
                }, 10);
            } else {
                console.warn('Failed to load customer summary');
                showDefaultWelcome();
            }
        } catch (error) {
            console.error('Error loading customer summary:', error);
            showDefaultWelcome();
        }
    }

    function renderCustomerSummaryMain(summary) {
        console.log('Rendering customer summary with data:', summary);

        // Update welcome title with personalized greeting
        const welcomeTitle = document.getElementById('welcomeTitle');
        if (welcomeTitle) {
            const userName = summary.displayName || summary.customerId || currentUser?.displayName || currentUser?.customerId || 'User';
            const currentHour = new Date().getHours();
            let greeting = 'Welcome back';

            if (currentHour < 12) {
                greeting = 'Good morning';
            } else if (currentHour < 17) {
                greeting = 'Good afternoon';
            } else {
                greeting = 'Good evening';
            }

            welcomeTitle.textContent = `${greeting}, ${userName}!`;
        }

        // Update AI summary with better formatting
        const aiSummaryContent = document.getElementById('aiSummaryMainContent');
        if (aiSummaryContent) {
            if (summary.aiSummary) {
                aiSummaryContent.innerHTML = '';

                const summaryContainer = document.createElement('div');
                summaryContainer.className = 'text-white leading-relaxed';
                summaryContainer.innerHTML = summary.aiSummary;

                // Apply white text styling to all elements for dark background
                summaryContainer.querySelectorAll('*').forEach(el => {
                    if (el.classList.contains('text-gray-700')) {
                        el.classList.remove('text-gray-700');
                        el.classList.add('text-white', 'text-opacity-90');
                    }
                    if (el.classList.contains('text-gray-800')) {
                        el.classList.remove('text-gray-800');
                        el.classList.add('text-white');
                    }
                    if (el.classList.contains('text-green-600')) {
                        el.classList.remove('text-green-600');
                        el.classList.add('text-green-300');
                    }
                    if (el.classList.contains('text-red-600')) {
                        el.classList.remove('text-red-600');
                        el.classList.add('text-red-300');
                    }
                    if (el.classList.contains('text-amber-600')) {
                        el.classList.remove('text-amber-600');
                        el.classList.add('text-amber-300');
                    }
                    if (el.classList.contains('text-blue-600')) {
                        el.classList.remove('text-blue-600');
                        el.classList.add('text-blue-300');
                    }
                });

                aiSummaryContent.appendChild(summaryContainer);
            } else {
                aiSummaryContent.innerHTML = `
                <div class='text-white leading-relaxed'>
                    <h4 class='font-semibold mb-3 flex items-center text-xl'>
                        <i class='fas fa-robot mr-3'></i>AI Assistant Ready
                    </h4>
                    <p class="text-lg">Welcome to Conversation Banking! I'm your AI-powered financial assistant, ready to help you with account inquiries, transfers, financial planning, and more. Start a conversation to explore what I can do for you.</p>
                </div>
            `;
            }
        }

        // Update stats
        const totalConversations = document.getElementById('totalConversations');
        const totalMessages = document.getElementById('totalMessages');
        const availableTools = document.getElementById('availableTools');
        const memberSince = document.getElementById('memberSince');
        const lastActiveTime = document.getElementById('lastActiveTime');

        if (totalConversations) totalConversations.textContent = summary.totalConversations || 0;
        if (totalMessages) totalMessages.textContent = summary.totalMessages || 0;
        if (availableTools) availableTools.textContent = summary.availableToolsCount || 0;
        if (memberSince) memberSince.textContent = summary.joinedAt || 'Today';
        if (lastActiveTime) lastActiveTime.textContent = `${summary.lastActiveAt || 'Now'}`;

        // Render recent activity
        renderRecentActivity();

        // Show the summary and hide default welcome
        const summaryMain = document.getElementById('customerSummaryMain');
        const defaultWelcome = document.getElementById('defaultWelcome');

        if (summaryMain) {
            summaryMain.classList.remove('hidden');
            console.log('Summary FORCED to show after data load');
        }
        if (defaultWelcome) {
            defaultWelcome.classList.add('hidden');
            console.log('Default welcome FORCED to hide after data load');
        }

        // Update conversation title
        document.getElementById('conversationTitle').textContent = 'Banking Dashboard';

        // Hide navigation buttons since we're in summary
        document.getElementById('deleteConversationBtn').classList.add('hidden');
        document.getElementById('backToSummaryBtn').classList.add('hidden');

        // Enable summary mode
        isSummaryMode = true;
        updateSummaryMode();

        // Ensure we stay in summary mode
        currentConversationId = null;
    }

    function renderRecentActivity() {
        const recentActivity = document.getElementById('recentActivity');

        if (!recentActivity) {
            console.log('Recent activity element not found');
            return;
        }

        if (conversations.length === 0) {
            recentActivity.innerHTML = `
                <div class="text-center text-gray-500 py-8">
                    <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-history text-2xl text-gray-400"></i>
                    </div>
                    <p class="text-lg font-medium mb-2">No conversations yet</p>
                    <p class="text-sm">Start your first banking conversation to see activity here!</p>
                </div>
            `;
            return;
        }

        // Show up to 3 most recent conversations
        const recentConversations = conversations.slice(0, 3);

        recentActivity.innerHTML = recentConversations.map(conv => `
            <div class="flex items-center space-x-4 p-4 bg-gray-50 rounded-xl hover:bg-blue-50 cursor-pointer transition duration-200 border border-gray-100"
                 onclick="loadConversationFromSummary('${conv.conversationId}')">
                <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                    <i class="fas fa-comment text-blue-600 text-lg"></i>
                </div>
                <div class="flex-1">
                    <div class="font-semibold text-gray-800 truncate mb-1">${escapeHtml(conv.title)}</div>
                    <div class="text-sm text-gray-500 truncate">${escapeHtml(conv.lastMessage)}</div>
                    <div class="text-xs text-gray-400 mt-1">${formatDate(conv.updatedAt)} • ${conv.messageCount} messages</div>
                </div>
                <div class="text-blue-600">
                    <i class="fas fa-chevron-right"></i>
                </div>
            </div>
        `).join('');

        console.log('Rendered recent activity with', recentConversations.length, 'conversations');
    }

    function showDefaultWelcome() {
        const summaryMain = document.getElementById('customerSummaryMain');
        const defaultWelcome = document.getElementById('defaultWelcome');

        if (summaryMain) {
            summaryMain.classList.add('hidden');
        }
        if (defaultWelcome) {
            defaultWelcome.classList.remove('hidden');
        }

        document.getElementById('conversationTitle').textContent = 'Conversation Banking';

        // Enable summary mode for default welcome too
        isSummaryMode = true;
        updateSummaryMode();
    }

    function showSummaryViewWithLoading() {
        document.getElementById('conversationTitle').textContent = 'Banking Dashboard';
        document.getElementById('deleteConversationBtn').classList.add('hidden');
        document.getElementById('backToSummaryBtn').classList.add('hidden');
        currentConversationId = null;
        isSummaryMode = true;
        updateSummaryMode();

        const summaryMain = document.getElementById('customerSummaryMain');
        const defaultWelcome = document.getElementById('defaultWelcome');

        if (summaryMain) {
            summaryMain.classList.remove('hidden');
            console.log('Summary view shown');
        }
        if (defaultWelcome) {
            defaultWelcome.classList.add('hidden');
            console.log('Default welcome hidden');
        }

        const aiSummaryContent = document.getElementById('aiSummaryMainContent');
        if (aiSummaryContent) {
            aiSummaryContent.innerHTML = '<div class="flex items-center text-white"><i class="fas fa-spinner fa-spin mr-3 text-xl"></i>Loading your personalized banking summary...</div>';
        }
    }

    function showSummaryView() {
        console.log('🔍 Redirecting to fresh dashboard state...');

        try {
            // Simply reload the page to get fresh dashboard state (like after login)
            window.location.reload();
        } catch (error) {
            console.error('❌ Error reloading page:', error);
            // Fallback: try to reset to initial state manually
            resetToInitialDashboardState();
        }
    }

    function resetToInitialDashboardState() {
        console.log('🔄 Resetting to initial dashboard state...');

        // Reset all state variables
        currentConversationId = null;
        isSummaryMode = true;
        updateSummaryMode();

        // Update UI elements
        document.getElementById('conversationTitle').textContent = 'Banking Dashboard';
        document.getElementById('deleteConversationBtn').classList.add('hidden');
        document.getElementById('backToSummaryBtn').classList.add('hidden');

        // Call the same initialization sequence as when user first logs in
        showSummaryViewWithLoading();

        // Reload all data fresh
        setTimeout(async () => {
            try {
                await loadUserSession();
                await loadCustomerSummary();
            } catch (error) {
                console.error('Error during dashboard reset:', error);
            }
        }, 100);
    }

    // Make showSummaryView globally accessible for onclick handler
    window.showSummaryView = showSummaryView;

    function updateSummaryMode() {
        const mainChatArea = document.getElementById('mainChatArea');
        if (isSummaryMode) {
            mainChatArea.classList.add('summary-mode');
        } else {
            mainChatArea.classList.remove('summary-mode');
        }
    }

    function setupEventListeners() {
        document.getElementById('messageForm').addEventListener('submit', handleMessageSubmit);

        const messageInput = document.getElementById('messageInput');
        messageInput.addEventListener('input', handleInputChange);
        messageInput.addEventListener('keydown', handleKeyDown);

        document.getElementById('newConversationBtn').addEventListener('click', startNewConversation);

        const startBtn = document.getElementById('startNewConversationBtn');
        if (startBtn) {
            startBtn.addEventListener('click', startNewConversation);
        }

        // Add event listeners for dashboard buttons
        const backToDashboardBtn = document.getElementById('backToDashboardBtn');
        if (backToDashboardBtn) {
            backToDashboardBtn.addEventListener('click', showSummaryView);
        }

        const backToSummaryBtn = document.getElementById('backToSummaryBtn');
        if (backToSummaryBtn) {
            backToSummaryBtn.addEventListener('click', showSummaryView);
        }
        document.getElementById('logoutBtn').addEventListener('click', handleLogout);
        document.getElementById('deleteConversationBtn').addEventListener('click', handleDeleteConversation);
        document.getElementById('sidebarToggle').addEventListener('click', toggleSidebar);
        document.getElementById('sidebarOverlay').addEventListener('click', closeSidebar);
    }

    function setupTextareaAutoResize() {
        const textarea = document.getElementById('messageInput');
        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });
    }

    function handleInputChange(e) {
        const input = e.target.value;
        const charCounter = document.getElementById('charCounter');
        const sendButton = document.getElementById('sendButton');

        charCounter.textContent = `${input.length}/4000`;
        sendButton.disabled = input.trim().length === 0 || isTyping;
    }

    function handleKeyDown(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            document.getElementById('messageForm').dispatchEvent(new Event('submit'));
        }
    }

    async function handleMessageSubmit(e) {
        e.preventDefault();

        // Prevent sending messages in summary mode
        if (isSummaryMode) {
            return;
        }

        const messageInput = document.getElementById('messageInput');
        const message = messageInput.value.trim();

        if (!message || isTyping) return;

        addMessageToUI('user', message);
        messageInput.value = '';
        messageInput.style.height = 'auto';
        handleInputChange({ target: messageInput });
        showTypingIndicator();

        try {
            const response = await fetch(`${API_BASE}/chat/message`, {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify({
                    message: message,
                    conversationId: currentConversationId,
                    newConversation: currentConversationId === null
                })
            });

            if (response.status === 401) {
                handleAuthError();
                return;
            }

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            const chatResponse = await response.json();

            if (!currentConversationId) {
                currentConversationId = chatResponse.conversationId;
                await refreshSessionData();
                document.getElementById('deleteConversationBtn').classList.remove('hidden');
            }

            addMessageToUI('assistant', chatResponse.response);

            if (document.getElementById('conversationTitle').textContent === 'New Conversation') {
                const title = message.length > 50 ? message.substring(0, 47) + '...' : message;
                document.getElementById('conversationTitle').textContent = title;
            }

        } catch (error) {
            console.error('Error sending message:', error);
            addMessageToUI('system', 'Sorry, there was an error sending your message. Please try again.');
        } finally {
            hideTypingIndicator();
        }
    }

    function addMessageToUI(type, content) {
        const messagesArea = document.getElementById('messagesArea');
        const messageDiv = document.createElement('div');

        // Convert URLs to clickable links
        const processedContent = makeUrlsClickable(content);

        if (type === 'user') {
            messageDiv.className = 'flex justify-end mb-4';
            messageDiv.innerHTML = `
                <div class="message-bubble bg-gradient-to-r from-blue-600 to-cyan-600 text-white p-4 rounded-2xl rounded-br-lg shadow-lg">
                    <div class="message-content font-medium">${processedContent}</div>
                    <div class="text-xs opacity-80 mt-2">${new Date().toLocaleTimeString()}</div>
                </div>
            `;
        } else if (type === 'assistant') {
            messageDiv.className = 'flex justify-start mb-4';
            messageDiv.innerHTML = `
                <div class="flex space-x-3 max-w-full">
                    <div class="w-10 h-10 viom-logo-bg rounded-full flex items-center justify-center flex-shrink-0 shadow-md">
                        <!-- Logo will show as background image -->
                    </div>
                    <div class="message-bubble bg-white border-2 border-gray-100 p-4 rounded-2xl rounded-bl-lg shadow-lg">
                        <div class="message-content text-gray-800">${processedContent}</div>
                        <div class="text-xs text-gray-500 mt-2 flex items-center">
                            <i class="fas fa-robot mr-1"></i>
                            AI Assistant • ${new Date().toLocaleTimeString()}
                        </div>
                    </div>
                </div>
            `;
        } else if (type === 'system') {
            messageDiv.className = 'flex justify-center mb-4';
            messageDiv.innerHTML = `
                <div class="bg-orange-100 border-2 border-orange-200 text-orange-800 p-3 rounded-xl text-sm shadow-sm">
                    <i class="fas fa-info-circle mr-2"></i>
                    ${processedContent}
                </div>
            `;
        }

        messagesArea.appendChild(messageDiv);
        scrollToBottom();
    }

    function makeUrlsClickable(text) {
        const urlRegex = /(https?:\/\/[^\s]+)|(www\.[^\s]+)|(\b[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}\b(?:\/[^\s]*)?)/g;

        return escapeHtml(text).replace(urlRegex, function(url) {
            let href = url;

            if (url.startsWith('www.')) {
                href = 'https://' + url;
            } else if (!url.startsWith('http://') && !url.startsWith('https://')) {
                href = 'https://' + url;
            }

            return `<a href="${href}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 underline font-medium">${url}</a>`;
        });
    }

    function showTypingIndicator() {
        isTyping = true;
        document.getElementById('typingIndicator').classList.remove('hidden');
        document.getElementById('sendButton').disabled = true;
        scrollToBottom();
    }

    function hideTypingIndicator() {
        isTyping = false;
        document.getElementById('typingIndicator').classList.add('hidden');
        const messageInput = document.getElementById('messageInput');
        document.getElementById('sendButton').disabled = messageInput.value.trim().length === 0;
    }

    function scrollToBottom() {
        const container = document.getElementById('messagesContainer');
        container.scrollTop = container.scrollHeight;
    }

    function renderConversations() {
        const conversationsList = document.getElementById('conversationsList');

        if (conversations.length === 0) {
            conversationsList.innerHTML = `
                <div class="text-center text-gray-500 text-sm py-6">
                    <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                        <i class="fas fa-comment text-gray-400"></i>
                    </div>
                    <p class="font-medium mb-1">No conversations yet</p>
                    <p class="text-xs">Start your first banking conversation!</p>
                </div>
            `;
            return;
        }

        const highlightId = currentConversationId;

        conversationsList.innerHTML = conversations.map(conv => `
            <div class="conversation-item p-4 rounded-xl cursor-pointer border-2 border-transparent hover:border-blue-100 hover:bg-blue-50 transition duration-200 ${conv.conversationId === highlightId ? 'bg-blue-50 border-blue-200 shadow-sm' : 'bg-gray-50'}"
                 data-conversation-id="${conv.conversationId}">
                <div class="flex items-start space-x-3">
                    <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-comment text-blue-600 text-sm"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="font-semibold text-sm text-gray-800 truncate mb-1">${escapeHtml(conv.title)}</div>
                        <div class="text-xs text-gray-500 truncate mb-2">${escapeHtml(conv.lastMessage)}</div>
                        <div class="flex items-center text-xs text-gray-400">
                            <i class="fas fa-clock mr-1"></i>
                            ${formatDate(conv.updatedAt)}
                            <span class="mx-1">•</span>
                            <i class="fas fa-comment mr-1"></i>
                            ${conv.messageCount}
                        </div>
                    </div>
                </div>
            </div>
        `).join('');

        conversationsList.querySelectorAll('.conversation-item').forEach(item => {
            item.addEventListener('click', () => {
                const conversationId = item.dataset.conversationId;
                loadConversation(conversationId);
            });
        });
    }

    async function loadConversation(conversationId) {
        try {
            currentConversationId = conversationId;
            isSummaryMode = false;
            updateSummaryMode();

            document.getElementById('conversationTitle').textContent = 'Loading conversation...';
            document.getElementById('deleteConversationBtn').classList.remove('hidden');
            document.getElementById('backToSummaryBtn').classList.remove('hidden');

            document.getElementById('messagesArea').innerHTML = `
                <div class="flex justify-center items-center py-12">
                    <div class="text-center">
                        <div class="w-16 h-16 viom-logo-bg rounded-full flex items-center justify-center mx-auto mb-4">
                            <!-- Logo will show as background image -->
                        </div>
                        <p class="text-gray-600 font-medium">Loading conversation...</p>
                    </div>
                </div>
            `;

            const response = await fetch(`${API_BASE}/chat/conversation/${conversationId}/messages`, {
                headers: getAuthHeaders()
            });

            if (response.status === 401) {
                handleAuthError();
                return;
            }

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            const messages = await response.json();
            const conversation = conversations.find(c => c.conversationId === conversationId);
            document.getElementById('conversationTitle').textContent = conversation ? conversation.title : 'Conversation';

            document.getElementById('messagesArea').innerHTML = '';

            messages.forEach(msg => {
                if (msg.messageType === 'USER') {
                    addMessageToUI('user', msg.content);
                } else if (msg.messageType === 'ASSISTANT') {
                    addMessageToUI('assistant', msg.content);
                }
            });

            renderConversations();
            closeSidebar();

        } catch (error) {
            console.error('Error loading conversation:', error);
            document.getElementById('conversationTitle').textContent = 'Error loading conversation';
            document.getElementById('messagesArea').innerHTML = `
                <div class="flex justify-center items-center py-12">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-exclamation-triangle text-2xl text-red-600"></i>
                        </div>
                        <p class="text-red-600 font-medium">Error loading conversation</p>
                        <p class="text-gray-500 text-sm mt-1">Please try again or select a different conversation</p>
                    </div>
                </div>
            `;
        }
    }

    window.loadConversationFromSummary = function(conversationId) {
        loadConversation(conversationId);
    }

    function startNewConversation() {
        currentConversationId = null;
        isSummaryMode = false;
        updateSummaryMode();

        document.getElementById('conversationTitle').textContent = 'New Conversation';
        document.getElementById('deleteConversationBtn').classList.add('hidden');

        // Make sure the back to dashboard button is visible and working
        const backBtn = document.getElementById('backToSummaryBtn');
        backBtn.classList.remove('hidden');
        console.log('Back to dashboard button should now be visible in new conversation');

        document.getElementById('messagesArea').innerHTML = `
            <div class="flex justify-center items-center py-12">
                <div class="text-center">
                    <div class="w-20 h-20 viom-logo-bg rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg">
                        <!-- Logo will show as background image -->
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-3">New Banking Conversation</h2>
                    <p class="text-gray-600 mb-6">Start by asking a question or requesting assistance below.</p>
                    <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 max-w-md mx-auto">
                        <div class="text-sm text-blue-800">
                            <div class="font-semibold mb-2">💡 Try asking:</div>
                            <ul class="text-left space-y-1">
                                <li>• "What's my account balance?"</li>
                                <li>• "Help me transfer money"</li>
                                <li>• "Show recent transactions"</li>
                                <li>• "I need financial advice"</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        `;
        renderConversations();
        closeSidebar();
        document.getElementById('messageInput').focus();
    }

    async function handleDeleteConversation() {
        if (!currentConversationId) return;

        if (!confirm('Are you sure you want to delete this conversation? This action cannot be undone.')) {
            return;
        }

        try {
            const response = await fetch(`${API_BASE}/chat/conversation/${currentConversationId}`, {
                method: 'DELETE',
                headers: getAuthHeaders()
            });

            if (response.status === 401) {
                handleAuthError();
                return;
            }

            if (response.ok) {
                await refreshSessionData();
                await loadCustomerSummary();
                showSummaryView();
            } else {
                alert('Failed to delete conversation. Please try again.');
            }
        } catch (error) {
            console.error('Error deleting conversation:', error);
            alert('Failed to delete conversation. Please try again.');
        }
    }

    function handleAuthError() {
        console.warn('Authentication error - redirecting to login');
        localStorage.removeItem('currentUser');
        localStorage.removeItem('jwtToken');
        window.location.href = '/';
    }

    async function handleLogout() {
        try {
            await fetch(`${API_BASE}/auth/logout`, {
                method: 'POST',
                headers: getAuthHeaders()
            });
        } catch (error) {
            console.warn('Logout request failed:', error);
        } finally {
            localStorage.removeItem('currentUser');
            localStorage.removeItem('jwtToken');
            window.location.href = '/';
        }
    }

    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebarOverlay');

        const isOpen = sidebar.classList.contains('sidebar-open-mobile');

        if (isOpen) {
            sidebar.classList.remove('sidebar-open-mobile');
            sidebar.classList.add('sidebar-closed-mobile');
            overlay.classList.add('hidden');
        } else {
            sidebar.classList.remove('sidebar-closed-mobile');
            sidebar.classList.add('sidebar-open-mobile');
            overlay.classList.remove('hidden');
        }
    }

    function closeSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebarOverlay');

        if (sidebar.classList.contains('sidebar-open-mobile')) {
            sidebar.classList.remove('sidebar-open-mobile');
            sidebar.classList.add('sidebar-closed-mobile');
            overlay.classList.add('hidden');
        }
    }

    function updateSidebarVisibility() {
        const sidebar = document.getElementById('sidebar');
        const mainChatArea = document.getElementById('mainChatArea');
        const overlay = document.getElementById('sidebarOverlay');

        if (window.innerWidth >= 1024) {
            sidebar.classList.remove('sidebar-closed-mobile', 'sidebar-open-mobile', 'fixed', 'top-0', 'left-0', 'h-screen', 'w-64', 'z-30');
            sidebar.classList.add('lg:w-80', 'lg:relative', 'lg:z-auto');
            overlay.classList.add('hidden');
            mainChatArea.classList.add('flex-1');
            mainChatArea.classList.remove('w-full');
        } else {
            sidebar.classList.remove('lg:w-80', 'lg:relative', 'lg:z-auto');
            sidebar.classList.add('fixed', 'top-0', 'left-0', 'h-screen', 'w-64', 'z-30');

            if (!sidebar.classList.contains('sidebar-open-mobile')) {
                sidebar.classList.add('sidebar-closed-mobile');
                sidebar.classList.remove('sidebar-open-mobile');
                overlay.classList.add('hidden');
            }

            mainChatArea.classList.add('w-full');
            mainChatArea.classList.remove('flex-1');
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffInHours = (now - date) / (1000 * 60 * 60);

        if (diffInHours < 1) {
            return 'Just now';
        } else if (diffInHours < 24) {
            return `${Math.floor(diffInHours)}h ago`;
        } else if (diffInHours < 168) {
            return `${Math.floor(diffInHours / 24)}d ago`;
        } else {
            return date.toLocaleDateString();
        }
    }

    // Handle window resize
    window.addEventListener('resize', updateSidebarVisibility);
</script>
</body>
</html>