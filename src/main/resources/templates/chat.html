<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Chat Client</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .chat-container {
            height: calc(100vh - 2rem);
        }
        .messages-container {
            height: calc(100% - 140px);
        }
        .message-bubble {
            max-width: 80%;
            word-wrap: break-word;
        }
        .typing-indicator {
            animation: pulse 1.5s ease-in-out infinite;
        }
        .loading-dots {
            display: inline-block;
        }
        .loading-dots:after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }
        @keyframes dots {
            0%, 20% { color: rgba(0,0,0,0); text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0); }
            40% { color: black; text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0); }
            60% { text-shadow: .25em 0 0 black, .5em 0 0 rgba(0,0,0,0); }
            80%, 100% { text-shadow: .25em 0 0 black, .5em 0 0 black; }
        }
        .sidebar-transition {
            transition: transform 0.3s ease-in-out;
        }
        .conversation-item:hover {
            background-color: rgba(99, 102, 241, 0.1);
        }
        .message-content {
            white-space: pre-wrap;
        }
        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .summary-stat {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }
        /* Mobile sidebar styles */
        @media (max-width: 1023px) {
            .sidebar-closed-mobile {
                width: 0 !important;
                min-width: 0 !important;
                overflow: hidden !important;
                transform: translateX(-100%);
            }
            .sidebar-open-mobile {
                transform: translateX(0);
            }
        }
    </style>
</head>
<body class="bg-gray-100">
<div class="flex h-screen">
    <!-- Sidebar -->
    <div id="sidebar" class="bg-white shadow-lg border-r border-gray-200 flex flex-col sidebar-transition sidebar-closed-mobile lg:w-80 lg:relative lg:z-auto fixed top-0 left-0 h-screen w-64 z-30">        <!-- Header -->
        <div class="p-4 border-b border-gray-200">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center space-x-2">
                    <div class="w-8 h-8 bg-indigo-600 rounded-full flex items-center justify-center">
                        <i class="fas fa-robot text-white text-sm"></i>
                    </div>
                    <span class="font-semibold text-gray-800" id="userDisplayName">Chat Client</span>
                </div>
                <button id="logoutBtn" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>

            <!-- New Conversation Button -->
            <button id="newConversationBtn" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-200 flex items-center justify-center space-x-2 mb-4">
                <i class="fas fa-plus"></i>
                <span>New Conversation</span>
            </button>

            <!-- Back to Dashboard Button (in sidebar) -->
            <button id="backToDashboardBtn" class="w-full bg-gray-100 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-200 transition duration-200 flex items-center justify-center space-x-2">
                <i class="fas fa-tachometer-alt"></i>
                <span>Dashboard</span>
            </button>
        </div>

        <!-- Conversations List -->
        <div class="flex-1 overflow-y-auto p-4">
            <h3 class="text-sm font-medium text-gray-500 mb-3">Recent Conversations</h3>
            <div id="conversationsList" class="space-y-2">
                <!-- Conversations will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div id="mainChatArea" class="flex-1 flex flex-col chat-container w-full">
        <!-- Chat Header -->
        <div class="bg-white shadow-sm border-b border-gray-200 p-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <button id="sidebarToggle" class="lg:hidden text-gray-500 hover:text-gray-700">
                        <i class="fas fa-bars"></i>
                    </button>

                    <!-- Back to Summary Button (show when in conversation) -->
                    <button id="backToSummaryBtn" class="hidden text-gray-500 hover:text-gray-700 p-2 rounded-lg hover:bg-gray-100 flex items-center space-x-2" title="Back to Account Overview">
                        <i class="fas fa-arrow-left"></i>
                        <span class="hidden sm:inline text-sm">Dashboard</span>
                    </button>

                    <h1 class="text-xl font-semibold text-gray-800" id="conversationTitle">
                        Select a conversation or start a new one
                    </h1>
                </div>
                <div class="flex items-center space-x-2">
                    <button id="deleteConversationBtn" class="hidden text-red-500 hover:text-red-700 p-2 rounded">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Messages Area -->
        <div id="messagesContainer" class="flex-1 overflow-y-auto p-4 messages-container">
            <div id="messagesArea" class="space-y-4">
                <!-- Customer Summary (shown by default) -->
                <div id="customerSummaryMain" class="hidden">
                    <div class="max-w-4xl mx-auto">
                        <!-- Welcome Header -->
                        <div class="text-center mb-8">
                            <div class="w-20 h-20 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-user-circle text-3xl text-indigo-600"></i>
                            </div>
                            <h2 class="text-2xl font-bold text-gray-800 mb-2" id="welcomeTitle">Welcome back!</h2>
                            <p class="text-gray-600" id="welcomeSubtitle">Here's your account overview</p>
                        </div>

                        <!-- AI Summary Card -->
                        <div id="aiSummaryCard" class="summary-card rounded-xl p-6 text-white mb-6">
                            <div class="flex items-center space-x-2 mb-4">
                                <i class="fas fa-robot"></i>
                                <span class="font-semibold">AI Assistant Summary</span>
                            </div>
                            <div id="aiSummaryMainContent" class="text-lg leading-relaxed">
                                <!-- AI-generated summary will be loaded here -->
                            </div>
                        </div>

                        <!-- Stats Grid -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-comments text-blue-600"></i>
                                    </div>
                                    <div>
                                        <div class="text-sm text-gray-500">Conversations</div>
                                        <div class="text-2xl font-bold text-gray-800" id="totalConversations">0</div>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-envelope text-green-600"></i>
                                    </div>
                                    <div>
                                        <div class="text-sm text-gray-500">Total Messages</div>
                                        <div class="text-2xl font-bold text-gray-800" id="totalMessages">0</div>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-tools text-purple-600"></i>
                                    </div>
                                    <div>
                                        <div class="text-sm text-gray-500">Available Tools</div>
                                        <div class="text-2xl font-bold text-gray-800" id="availableTools">0</div>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-indigo-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-calendar text-indigo-600"></i>
                                    </div>
                                    <div>
                                        <div class="text-sm text-gray-500">Member Since</div>
                                        <div class="text-sm font-bold text-gray-800" id="memberSince">-</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Recent Activity -->
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center space-x-2">
                                    <i class="fas fa-clock text-gray-600"></i>
                                    <h3 class="text-lg font-semibold text-gray-800">Recent Activity</h3>
                                </div>
                                <span class="text-sm text-gray-500" id="lastActiveTime">-</span>
                            </div>
                            <div id="recentActivity" class="space-y-3">
                                <!-- Recent conversations will be shown here -->
                            </div>
                        </div>

                        <!-- Call to Action -->
                        <div class="text-center mt-8">
                            <button id="startNewConversationBtn" class="bg-indigo-600 text-white px-8 py-3 rounded-lg hover:bg-indigo-700 transition duration-200 flex items-center justify-center space-x-2 mx-auto">
                                <i class="fas fa-plus"></i>
                                <span>Start New Conversation</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Default welcome message (fallback) -->
                <div id="defaultWelcome" class="flex justify-center">
                    <div class="text-center p-8">
                        <div class="w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-robot text-2xl text-indigo-600"></i>
                        </div>
                        <h2 class="text-xl font-semibold text-gray-800 mb-2">Welcome to MCP Chat!</h2>
                        <p class="text-gray-600">Start a conversation or select an existing one from the sidebar.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Typing Indicator -->
        <div id="typingIndicator" class="hidden px-4 py-2">
            <div class="flex items-center space-x-2 text-gray-500">
                <div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center">
                    <i class="fas fa-robot text-sm"></i>
                </div>
                <span class="typing-indicator">AI is typing<span class="loading-dots"></span></span>
            </div>
        </div>

        <!-- Message Input -->
        <div class="bg-white border-t border-gray-200 p-4">
            <form id="messageForm" class="flex space-x-3">
                <div class="flex-1 relative">
                    <textarea
                            id="messageInput"
                            placeholder="Type your message..."
                            class="w-full p-3 border border-gray-300 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                            rows="2"
                            maxlength="4000"
                    ></textarea>
                    <div id="charCounter" class="absolute bottom-1 right-2 text-xs text-gray-400">0/4000</div>
                </div>
                <button
                        type="submit"
                        id="sendButton"
                        class="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-200 flex items-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled
                >
                    <i class="fas fa-paper-plane"></i>
                    <span class="hidden sm:inline">Send</span>
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Mobile sidebar overlay -->
<div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 lg:hidden hidden"></div>

<script>
    function getAuthHeaders() {
        const jwtToken = localStorage.getItem('jwtToken');
        const headers = {
            'Content-Type': 'application/json'
        };

        if (jwtToken) {
            headers['Authorization'] = `Bearer ${jwtToken}`;
        }

        return headers;
    }

    const API_BASE = '/api';
    let currentUser = null;
    let currentConversationId = null;
    let conversations = [];
    let isTyping = false;

    // Initialize the application
    document.addEventListener('DOMContentLoaded', function() {
        initializeApp();
    });

    async function initializeApp() {
        const userData = localStorage.getItem('currentUser');
        const jwtToken = localStorage.getItem('jwtToken');

        if (!userData || !jwtToken) {
            window.location.href = '/';
            return;
        }

        currentUser = JSON.parse(userData);
        document.getElementById('userDisplayName').textContent = currentUser.displayName || currentUser.customerId;

        // Initialize with summary view
        showSummaryViewWithLoading();

        await loadUserSession();

        await loadCustomerSummary();
        setupEventListeners();
        setupTextareaAutoResize();
        updateSidebarVisibility();
    }

    async function loadUserSession() {
        try {
            const response = await fetch(`${API_BASE}/chat/session/${currentUser.customerId}`, {
                headers: getAuthHeaders()
            });

            if (response.status === 401) {
                handleAuthError();
                return;
            }

            if (response.ok) {
                const sessionData = await response.json();
                conversations = sessionData.conversations || [];
                renderConversations();

                // Don't auto-load the latest conversation - keep showing summary
                // Only auto-load if we're in a specific conversation context
                // if (sessionData.currentConversationId) {
                //     await loadConversation(sessionData.currentConversationId);
                // }
            } else {
                console.warn('Failed to load user session');
            }
        } catch (error) {
            console.error('Error loading user session:', error);
        }
    }

    async function loadCustomerSummary() {
        console.log('Loading customer summary...');
        try {
            const response = await fetch(`${API_BASE}/chat/summary/${currentUser.customerId}`, {
                headers: getAuthHeaders()
            });

            if (response.status === 401) {
                handleAuthError();
                return;
            }

            if (response.ok) {
                const summary = await response.json();
                console.log('Customer summary loaded successfully');

                // Use setTimeout to ensure this runs after any other DOM updates
                setTimeout(() => {
                    renderCustomerSummaryMain(summary);
                }, 10);
            } else {
                console.warn('Failed to load customer summary');
                showDefaultWelcome();
            }
        } catch (error) {
            console.error('Error loading customer summary:', error);
            showDefaultWelcome();
        }
    }

    function renderCustomerSummaryMain(summary) {
        console.log('Rendering customer summary with data:', summary);

        // Update welcome title
        const welcomeTitle = document.getElementById('welcomeTitle');
        if (welcomeTitle) {
            welcomeTitle.textContent = `Welcome back, ${summary.displayName || summary.customerId}!`;
        }

        // Update AI summary with better formatting
        const aiSummaryContent = document.getElementById('aiSummaryMainContent');
        if (aiSummaryContent) {
            if (summary.aiSummary) {
                // Clear existing content
                aiSummaryContent.innerHTML = '';

                // Create formatted container
                const summaryContainer = document.createElement('div');
                summaryContainer.className = 'text-white leading-relaxed';
                summaryContainer.innerHTML = summary.aiSummary;

                // Apply white text styling to all elements for dark background
                summaryContainer.querySelectorAll('*').forEach(el => {
                    if (el.classList.contains('text-gray-700')) {
                        el.classList.remove('text-gray-700');
                        el.classList.add('text-white', 'text-opacity-90');
                    }
                    if (el.classList.contains('text-gray-800')) {
                        el.classList.remove('text-gray-800');
                        el.classList.add('text-white');
                    }
                    // Keep color-coded elements but ensure they're visible on dark background
                    if (el.classList.contains('text-green-600')) {
                        el.classList.remove('text-green-600');
                        el.classList.add('text-green-300');
                    }
                    if (el.classList.contains('text-red-600')) {
                        el.classList.remove('text-red-600');
                        el.classList.add('text-red-300');
                    }
                    if (el.classList.contains('text-amber-600')) {
                        el.classList.remove('text-amber-600');
                        el.classList.add('text-amber-300');
                    }
                    if (el.classList.contains('text-blue-600')) {
                        el.classList.remove('text-blue-600');
                        el.classList.add('text-blue-300');
                    }
                });

                aiSummaryContent.appendChild(summaryContainer);
            } else {
                aiSummaryContent.innerHTML = `
                <div class='text-white leading-relaxed'>
                    <h4 class='font-semibold mb-2 flex items-center'>
                        <i class='fas fa-robot mr-2'></i>AI Assistant Ready
                    </h4>
                    <p>Welcome! I'm here to help you with various banking tasks using the available tools. Start a conversation to see what I can do for you.</p>
                </div>
            `;
            }
        }

        // Update stats
        const totalConversations = document.getElementById('totalConversations');
        const totalMessages = document.getElementById('totalMessages');
        const availableTools = document.getElementById('availableTools');
        const memberSince = document.getElementById('memberSince');
        const lastActiveTime = document.getElementById('lastActiveTime');

        if (totalConversations) totalConversations.textContent = summary.totalConversations || 0;
        if (totalMessages) totalMessages.textContent = summary.totalMessages || 0;
        if (availableTools) availableTools.textContent = summary.availableToolsCount || 0;
        if (memberSince) memberSince.textContent = summary.joinedAt || 'Today';
        if (lastActiveTime) lastActiveTime.textContent = `Last active: ${summary.lastActiveAt || 'Now'}`;

        // Render tools
        renderToolsList(summary.availableTools || []);

        // Render recent activity
        renderRecentActivity();

        // FORCE show the summary and hide default welcome
        const summaryMain = document.getElementById('customerSummaryMain');
        const defaultWelcome = document.getElementById('defaultWelcome');

        if (summaryMain) {
            summaryMain.classList.remove('hidden');
            console.log('Summary FORCED to show after data load');
        }
        if (defaultWelcome) {
            defaultWelcome.classList.add('hidden');
            console.log('Default welcome FORCED to hide after data load');
        }

        // Update conversation title
        document.getElementById('conversationTitle').textContent = 'Account Overview';

        // Hide navigation buttons since we're in summary
        document.getElementById('deleteConversationBtn').classList.add('hidden');
        document.getElementById('backToSummaryBtn').classList.add('hidden');

        // Ensure we stay in summary mode
        currentConversationId = null;
    }

    function renderToolsList(tools) {
        const toolsList = document.getElementById('toolsList');

        if (tools.length === 0) {
            toolsList.innerHTML = `
                <div class="col-span-2 text-center text-gray-500 py-4">
                    <i class="fas fa-tools text-2xl mb-2"></i>
                    <p>No tools currently available</p>
                </div>
            `;
            return;
        }

        toolsList.innerHTML = tools.map(tool => `
            <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg">
                <div class="w-8 h-8 bg-indigo-100 rounded-lg flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-cog text-indigo-600 text-sm"></i>
                </div>
                <div class="flex-1">
                    <div class="font-medium text-sm text-gray-800">${escapeHtml(tool.name)}</div>
                    <div class="text-xs text-gray-600 mt-1">${escapeHtml(tool.description)}</div>
                </div>
            </div>
        `).join('');
    }

    function renderRecentActivity() {
        const recentActivity = document.getElementById('recentActivity');

        if (!recentActivity) {
            console.log('Recent activity element not found');
            return;
        }

        if (conversations.length === 0) {
            recentActivity.innerHTML = `
                <div class="text-center text-gray-500 py-4">
                    <i class="fas fa-history text-2xl mb-2"></i>
                    <p>No conversations yet. Start your first conversation!</p>
                </div>
            `;
            return;
        }

        // Show up to 3 most recent conversations
        const recentConversations = conversations.slice(0, 3);

        recentActivity.innerHTML = recentConversations.map(conv => `
            <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer transition duration-200"
                 onclick="loadConversationFromSummary('${conv.conversationId}')">
                <div class="w-8 h-8 bg-indigo-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-comment text-indigo-600 text-sm"></i>
                </div>
                <div class="flex-1">
                    <div class="font-medium text-sm text-gray-800 truncate">${escapeHtml(conv.title)}</div>
                    <div class="text-xs text-gray-500 truncate">${escapeHtml(conv.lastMessage)}</div>
                </div>
                <div class="text-xs text-gray-400">${formatDate(conv.updatedAt)}</div>
            </div>
        `).join('');

        console.log('Rendered recent activity with', recentConversations.length, 'conversations');
    }

    function showDefaultWelcome() {
        const summaryMain = document.getElementById('customerSummaryMain');
        const defaultWelcome = document.getElementById('defaultWelcome');

        if (summaryMain) {
            summaryMain.classList.add('hidden');
        }
        if (defaultWelcome) {
            defaultWelcome.classList.remove('hidden');
        }

        document.getElementById('conversationTitle').textContent = 'Welcome to MCP Chat';
    }

    // Show summary by default with loading state
    function showSummaryViewWithLoading() {
        // Update conversation title immediately
        document.getElementById('conversationTitle').textContent = 'Account Overview';

        // Hide navigation buttons since we're in summary
        document.getElementById('deleteConversationBtn').classList.add('hidden');
        document.getElementById('backToSummaryBtn').classList.add('hidden');

        // Ensure we're not in a conversation
        currentConversationId = null;

        // Show the summary view
        const summaryMain = document.getElementById('customerSummaryMain');
        const defaultWelcome = document.getElementById('defaultWelcome');

        if (summaryMain) {
            summaryMain.classList.remove('hidden');
            console.log('Summary view shown');
        }
        if (defaultWelcome) {
            defaultWelcome.classList.add('hidden');
            console.log('Default welcome hidden');
        }

        // Show loading state in AI summary
        const aiSummaryContent = document.getElementById('aiSummaryMainContent');
        if (aiSummaryContent) {
            aiSummaryContent.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Loading your personalized summary...';
        }
    }

    function showSummaryView() {
        console.log('showSummaryView() called - returning to dashboard');

        // Clear the messages area completely and rebuild summary
        const messagesArea = document.getElementById('messagesArea');
        messagesArea.innerHTML = `
            <!-- Customer Summary (shown by default) -->
            <div id="customerSummaryMain" class="">
                <div class="max-w-4xl mx-auto">
                    <!-- Welcome Header -->
                    <div class="text-center mb-8">
                        <div class="w-20 h-20 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-user-circle text-3xl text-indigo-600"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-2" id="welcomeTitle">Welcome back!</h2>
                        <p class="text-gray-600" id="welcomeSubtitle">Here's your account overview</p>
                    </div>

                    <!-- AI Summary Card -->
                    <div id="aiSummaryCard" class="summary-card rounded-xl p-6 text-white mb-6">
                        <div class="flex items-center space-x-2 mb-4">
                            <i class="fas fa-robot"></i>
                            <span class="font-semibold">AI Assistant Summary</span>
                        </div>
                        <div id="aiSummaryMainContent" class="text-lg leading-relaxed">
                            <i class="fas fa-spinner fa-spin mr-2"></i>Loading your personalized summary...
                        </div>
                    </div>

                    <!-- Stats Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-comments text-blue-600"></i>
                                </div>
                                <div>
                                    <div class="text-sm text-gray-500">Conversations</div>
                                    <div class="text-2xl font-bold text-gray-800" id="totalConversations">-</div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-envelope text-green-600"></i>
                                </div>
                                <div>
                                    <div class="text-sm text-gray-500">Total Messages</div>
                                    <div class="text-2xl font-bold text-gray-800" id="totalMessages">-</div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-tools text-purple-600"></i>
                                </div>
                                <div>
                                    <div class="text-sm text-gray-500">Available Tools</div>
                                    <div class="text-2xl font-bold text-gray-800" id="availableTools">-</div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 bg-indigo-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-calendar text-indigo-600"></i>
                                </div>
                                <div>
                                    <div class="text-sm text-gray-500">Member Since</div>
                                    <div class="text-sm font-bold text-gray-800" id="memberSince">-</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Available Tools Section -->
                    <div id="toolsSection" class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
                        <div class="flex items-center space-x-2 mb-4">
                            <i class="fas fa-toolbox text-gray-600"></i>
                            <h3 class="text-lg font-semibold text-gray-800">Available Tools</h3>
                        </div>
                        <div id="toolsList" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div class="col-span-2 text-center text-gray-500 py-4">
                                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                <p>Loading available tools...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-clock text-gray-600"></i>
                                <h3 class="text-lg font-semibold text-gray-800">Recent Activity</h3>
                            </div>
                            <span class="text-sm text-gray-500" id="lastActiveTime">-</span>
                        </div>
                        <div id="recentActivity" class="space-y-3">
                            <div class="text-center text-gray-500 py-4">
                                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                <p>Loading recent activity...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Call to Action -->
                    <div class="text-center mt-8">
                        <button id="startNewConversationBtn" class="bg-indigo-600 text-white px-8 py-3 rounded-lg hover:bg-indigo-700 transition duration-200 flex items-center justify-center space-x-2 mx-auto">
                            <i class="fas fa-plus"></i>
                            <span>Start New Conversation</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Default welcome message (fallback) -->
            <div id="defaultWelcome" class="hidden flex justify-center">
                <div class="text-center p-8">
                    <div class="w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-robot text-2xl text-indigo-600"></i>
                    </div>
                    <h2 class="text-xl font-semibold text-gray-800 mb-2">Welcome to MCP Chat!</h2>
                    <p class="text-gray-600">Start a conversation or select an existing one from the sidebar.</p>
                </div>
            </div>
        `;

        // Update header and navigation state
        document.getElementById('conversationTitle').textContent = 'Account Overview';
        document.getElementById('deleteConversationBtn').classList.add('hidden');
        document.getElementById('backToSummaryBtn').classList.add('hidden');
        currentConversationId = null;

        // Re-bind the event listener for the new button
        const newConvBtn = document.getElementById('startNewConversationBtn');
        if (newConvBtn) {
            newConvBtn.addEventListener('click', startNewConversation);
        }

        // Load fresh data
        loadCustomerSummary();
        renderConversations();

        console.log('Summary view recreated successfully');
    }

    function setupEventListeners() {
        // Message form submission
        document.getElementById('messageForm').addEventListener('submit', handleMessageSubmit);

        // Message input changes
        const messageInput = document.getElementById('messageInput');
        messageInput.addEventListener('input', handleInputChange);
        messageInput.addEventListener('keydown', handleKeyDown);

        // New conversation button
        document.getElementById('newConversationBtn').addEventListener('click', startNewConversation);

        // Start new conversation from summary
        const startBtn = document.getElementById('startNewConversationBtn');
        if (startBtn) {
            startBtn.addEventListener('click', startNewConversation);
        }

        // Back to summary buttons
        document.getElementById('backToSummaryBtn').addEventListener('click', showSummaryView);
        document.getElementById('backToDashboardBtn').addEventListener('click', showSummaryView);

        // Logout button
        document.getElementById('logoutBtn').addEventListener('click', handleLogout);

        // Delete conversation button
        document.getElementById('deleteConversationBtn').addEventListener('click', handleDeleteConversation);

        // Sidebar toggle for mobile
        document.getElementById('sidebarToggle').addEventListener('click', toggleSidebar);
        document.getElementById('sidebarOverlay').addEventListener('click', closeSidebar);
    }

    function setupTextareaAutoResize() {
        const textarea = document.getElementById('messageInput');
        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });
    }

    function handleInputChange(e) {
        const input = e.target.value;
        const charCounter = document.getElementById('charCounter');
        const sendButton = document.getElementById('sendButton');

        charCounter.textContent = `${input.length}/4000`;
        sendButton.disabled = input.trim().length === 0 || isTyping;
    }

    function handleKeyDown(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            document.getElementById('messageForm').dispatchEvent(new Event('submit'));
        }
    }

    async function handleMessageSubmit(e) {
        e.preventDefault();

        const messageInput = document.getElementById('messageInput');
        const message = messageInput.value.trim();

        if (!message || isTyping) return;

        addMessageToUI('user', message);
        messageInput.value = '';
        messageInput.style.height = 'auto';
        handleInputChange({ target: messageInput });
        showTypingIndicator();

        try {
            const response = await fetch(`${API_BASE}/chat/message`, {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify({
                    customerId: currentUser.customerId,
                    message: message,
                    conversationId: currentConversationId,
                    newConversation: currentConversationId === null
                })
            });

            if (response.status === 401) {
                handleAuthError();
                return;
            }

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            const chatResponse = await response.json();

            if (!currentConversationId) {
                currentConversationId = chatResponse.conversationId;
                await loadUserSession();
                document.getElementById('deleteConversationBtn').classList.remove('hidden');
            }

            addMessageToUI('assistant', chatResponse.response);

            if (document.getElementById('conversationTitle').textContent === 'New Conversation') {
                const title = message.length > 50 ? message.substring(0, 47) + '...' : message;
                document.getElementById('conversationTitle').textContent = title;
            }

        } catch (error) {
            console.error('Error sending message:', error);
            addMessageToUI('system', 'Sorry, there was an error sending your message. Please try again.');
        } finally {
            hideTypingIndicator();
        }
    }

    function addMessageToUI(type, content) {
        const messagesArea = document.getElementById('messagesArea');
        const messageDiv = document.createElement('div');

        if (type === 'user') {
            messageDiv.className = 'flex justify-end';
            messageDiv.innerHTML = `
                <div class="message-bubble bg-indigo-600 text-white p-3 rounded-lg rounded-br-none">
                    <div class="message-content">${escapeHtml(content)}</div>
                    <div class="text-xs opacity-75 mt-1">${new Date().toLocaleTimeString()}</div>
                </div>
            `;
        } else if (type === 'assistant') {
            messageDiv.className = 'flex justify-start';
            messageDiv.innerHTML = `
                <div class="flex space-x-2 max-w-full">
                    <div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-robot text-sm text-gray-600"></i>
                    </div>
                    <div class="message-bubble bg-white border border-gray-200 p-3 rounded-lg rounded-bl-none">
                        <div class="message-content">${escapeHtml(content)}</div>
                        <div class="text-xs text-gray-500 mt-1">${new Date().toLocaleTimeString()}</div>
                    </div>
                </div>
            `;
        } else if (type === 'system') {
            messageDiv.className = 'flex justify-center';
            messageDiv.innerHTML = `
                <div class="bg-yellow-100 border border-yellow-200 text-yellow-800 p-2 rounded text-sm">
                    ${escapeHtml(content)}
                </div>
            `;
        }

        messagesArea.appendChild(messageDiv);
        scrollToBottom();
    }

    function showTypingIndicator() {
        isTyping = true;
        document.getElementById('typingIndicator').classList.remove('hidden');
        document.getElementById('sendButton').disabled = true;
        scrollToBottom();
    }

    function hideTypingIndicator() {
        isTyping = false;
        document.getElementById('typingIndicator').classList.add('hidden');
        const messageInput = document.getElementById('messageInput');
        document.getElementById('sendButton').disabled = messageInput.value.trim().length === 0;
    }

    function scrollToBottom() {
        const container = document.getElementById('messagesContainer');
        container.scrollTop = container.scrollHeight;
    }

    function renderConversations() {
        const conversationsList = document.getElementById('conversationsList');

        if (conversations.length === 0) {
            conversationsList.innerHTML = `
                <div class="text-center text-gray-500 text-sm py-4">
                    No conversations yet.<br>Start a new one!
                </div>
            `;
            return;
        }

        // Don't highlight any conversation if we're in summary view
        const highlightId = currentConversationId;

        conversationsList.innerHTML = conversations.map(conv => `
            <div class="conversation-item p-3 rounded-lg cursor-pointer border border-transparent hover:border-indigo-200 ${conv.conversationId === highlightId ? 'bg-indigo-50 border-indigo-200' : ''}"
                 data-conversation-id="${conv.conversationId}">
                <div class="font-medium text-sm text-gray-800 truncate">${escapeHtml(conv.title)}</div>
                <div class="text-xs text-gray-500 mt-1 truncate">${escapeHtml(conv.lastMessage)}</div>
                <div class="text-xs text-gray-400 mt-1">${formatDate(conv.updatedAt)} • ${conv.messageCount} messages</div>
            </div>
        `).join('');

        // Add click listeners to conversation items
        conversationsList.querySelectorAll('.conversation-item').forEach(item => {
            item.addEventListener('click', () => {
                const conversationId = item.dataset.conversationId;
                loadConversation(conversationId);
            });
        });
    }

    async function loadConversation(conversationId) {
        try {
            currentConversationId = conversationId;
            document.getElementById('conversationTitle').textContent = 'Loading...';
            document.getElementById('deleteConversationBtn').classList.remove('hidden');
            document.getElementById('backToSummaryBtn').classList.remove('hidden');

            // Clear the messages area and hide summary
            document.getElementById('messagesArea').innerHTML = '';

            const response = await fetch(`${API_BASE}/chat/conversation/${conversationId}/messages`, {
                headers: getAuthHeaders()
            });

            if (response.status === 401) {
                handleAuthError();
                return;
            }

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            const messages = await response.json();
            const conversation = conversations.find(c => c.conversationId === conversationId);
            document.getElementById('conversationTitle').textContent = conversation ? conversation.title : 'Conversation';

            messages.forEach(msg => {
                if (msg.messageType === 'USER') {
                    addMessageToUI('user', msg.content);
                } else if (msg.messageType === 'ASSISTANT') {
                    addMessageToUI('assistant', msg.content);
                }
            });

            renderConversations();
            closeSidebar();

        } catch (error) {
            console.error('Error loading conversation:', error);
            document.getElementById('conversationTitle').textContent = 'Error loading conversation';
        }
    }

    // Function to load conversation from summary page
    window.loadConversationFromSummary = function(conversationId) {
        loadConversation(conversationId);
    }

    function startNewConversation() {
        currentConversationId = null;
        document.getElementById('conversationTitle').textContent = 'New Conversation';
        document.getElementById('deleteConversationBtn').classList.add('hidden');
        document.getElementById('backToSummaryBtn').classList.remove('hidden');
        document.getElementById('messagesArea').innerHTML = `
            <div class="flex justify-center">
                <div class="text-center p-8">
                    <div class="w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-robot text-2xl text-indigo-600"></i>
                    </div>
                    <h2 class="text-xl font-semibold text-gray-800 mb-2">New Conversation</h2>
                    <p class="text-gray-600">Start by sending a message below.</p>
                </div>
            </div>
        `;
        renderConversations();
        closeSidebar();
        document.getElementById('messageInput').focus();
    }

    async function handleDeleteConversation() {
        if (!currentConversationId) return;

        if (!confirm('Are you sure you want to delete this conversation? This action cannot be undone.')) {
            return;
        }

        try {
            const response = await fetch(`${API_BASE}/chat/conversation/${currentConversationId}?customerId=${currentUser.customerId}`, {
                method: 'DELETE',
                headers: getAuthHeaders()
            });

            if (response.status === 401) {
                handleAuthError();
                return;
            }

            if (response.ok) {
                await loadUserSession();
                await loadCustomerSummary(); // Refresh summary after deletion
                showSummaryView(); // Return to summary view
            } else {
                alert('Failed to delete conversation. Please try again.');
            }
        } catch (error) {
            console.error('Error deleting conversation:', error);
            alert('Failed to delete conversation. Please try again.');
        }
    }

    function handleAuthError() {
        console.warn('Authentication error - redirecting to login');
        localStorage.removeItem('currentUser');
        localStorage.removeItem('jwtToken');
        window.location.href = '/';
    }

    async function handleLogout() {
        try {
            await fetch(`${API_BASE}/auth/logout?customerId=${currentUser.customerId}`, {
                method: 'POST',
                headers: getAuthHeaders()
            });
        } catch (error) {
            console.warn('Logout request failed:', error);
        } finally {
            localStorage.removeItem('currentUser');
            localStorage.removeItem('jwtToken');
            window.location.href = '/';
        }
    }

    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebarOverlay');

        const isOpen = sidebar.classList.contains('sidebar-open-mobile');

        if (isOpen) {
            sidebar.classList.remove('sidebar-open-mobile');
            sidebar.classList.add('sidebar-closed-mobile');
            overlay.classList.add('hidden');
        } else {
            sidebar.classList.remove('sidebar-closed-mobile');
            sidebar.classList.add('sidebar-open-mobile');
            overlay.classList.remove('hidden');
        }
    }

    function closeSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebarOverlay');

        if (sidebar.classList.contains('sidebar-open-mobile')) {
            sidebar.classList.remove('sidebar-open-mobile');
            sidebar.classList.add('sidebar-closed-mobile');
            overlay.classList.add('hidden');
        }
    }

    function updateSidebarVisibility() {
        const sidebar = document.getElementById('sidebar');
        const mainChatArea = document.getElementById('mainChatArea');
        const overlay = document.getElementById('sidebarOverlay');

        if (window.innerWidth >= 1024) {
            sidebar.classList.remove('sidebar-closed-mobile', 'sidebar-open-mobile', 'fixed', 'top-0', 'left-0', 'h-screen', 'w-64', 'z-30');
            sidebar.classList.add('lg:w-80', 'lg:relative', 'lg:z-auto');
            overlay.classList.add('hidden');
            mainChatArea.classList.add('flex-1');
            mainChatArea.classList.remove('w-full');
        } else {
            sidebar.classList.remove('lg:w-80', 'lg:relative', 'lg:z-auto');
            sidebar.classList.add('fixed', 'top-0', 'left-0', 'h-screen', 'w-64', 'z-30');

            if (!sidebar.classList.contains('sidebar-open-mobile')) {
                sidebar.classList.add('sidebar-closed-mobile');
                sidebar.classList.remove('sidebar-open-mobile');
                overlay.classList.add('hidden');
            }

            mainChatArea.classList.add('w-full');
            mainChatArea.classList.remove('flex-1');
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffInHours = (now - date) / (1000 * 60 * 60);

        if (diffInHours < 1) {
            return 'Just now';
        } else if (diffInHours < 24) {
            return `${Math.floor(diffInHours)}h ago`;
        } else if (diffInHours < 168) {
            return `${Math.floor(diffInHours / 24)}d ago`;
        } else {
            return date.toLocaleDateString();
        }
    }

    // Handle window resize
    window.addEventListener('resize', updateSidebarVisibility);
</script>
</body>
</html>