<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conversation Banking - Viom Technologies</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .viom-gradient {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 25%, #06b6d4 50%, #0891b2 75%, #0e7490 100%);
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.1);
        }
        .viom-logo-bg {
            background: linear-gradient(45deg, #1e40af, #3b82f6);
            background-image: url('/static/images/viom-logo.png');
            background-size: 130%;
            background-repeat: no-repeat;
            background-position: center;
        }
        .viom-logo-bg-text {
            background: linear-gradient(45deg, #1e40af, #3b82f6);
        }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #1e40af;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .floating-animation {
            animation: float 6s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        .feature-card {
            transition: all 0.3s ease;
        }
        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="viom-gradient min-h-screen">
<!-- Header -->
<nav class="p-6">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
        <div class="flex items-center space-x-4">
            <div class="w-12 h-12 viom-logo-bg rounded-lg flex items-center justify-center shadow-lg">
                <!-- Logo will show as background image -->
            </div>
            <div>
                <div class="text-white font-bold text-lg">Viom Technologies</div>
                <div class="text-blue-100 text-sm">www.viom.tech</div>
            </div>
        </div>
        <div class="text-right">
            <div class="text-white font-semibold">Conversation Banking</div>
            <div class="text-blue-100 text-sm">Powered by Anthropic & Spring</div>
        </div>
    </div>
</nav>

<div class="flex items-center justify-center min-h-screen px-4 -mt-20">
    <div class="w-full max-w-6xl">
        <div class="grid lg:grid-cols-2 gap-12 items-center">
            <!-- Left Side - Product Information -->
            <div class="text-center lg:text-left">
                <div class="floating-animation mb-8">
                    <div class="w-24 h-24 viom-logo-bg rounded-2xl flex items-center justify-center mx-auto lg:mx-0 shadow-2xl mb-6">
                        <!-- Logo will show as background image -->
                    </div>
                </div>

                <h1 class="text-5xl lg:text-6xl font-bold text-white mb-6 leading-tight">
                    Conversation<br>
                    <span class="text-cyan-300">Banking</span>
                </h1>

                <p class="text-xl text-blue-100 mb-8 leading-relaxed">
                    Experience the future of banking with AI-powered conversations.
                    Secure, intelligent, and personalized financial assistance at your fingertips.
                </p>

                <!-- Feature highlights -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                    <div class="feature-card glass-effect rounded-xl p-4 text-left">
                        <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center mb-3">
                            <i class="fas fa-shield-alt text-white"></i>
                        </div>
                        <h3 class="font-semibold text-gray-800 mb-2">Bank-Grade Security</h3>
                        <p class="text-gray-600 text-sm">OAuth2 authentication with enterprise-level encryption</p>
                    </div>

                    <div class="feature-card glass-effect rounded-xl p-4 text-left">
                        <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center mb-3">
                            <i class="fas fa-robot text-white"></i>
                        </div>
                        <h3 class="font-semibold text-gray-800 mb-2">AI-Powered Assistant</h3>
                        <p class="text-gray-600 text-sm">Claude AI integration for intelligent financial guidance</p>
                    </div>

                    <div class="feature-card glass-effect rounded-xl p-4 text-left">
                        <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center mb-3">
                            <i class="fas fa-clock text-white"></i>
                        </div>
                        <h3 class="font-semibold text-gray-800 mb-2">24/7 Availability</h3>
                        <p class="text-gray-600 text-sm">Round-the-clock banking assistance whenever you need it</p>
                    </div>

                    <div class="feature-card glass-effect rounded-xl p-4 text-left">
                        <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center mb-3">
                            <i class="fas fa-user-circle text-white"></i>
                        </div>
                        <h3 class="font-semibold text-gray-800 mb-2">Personalized Experience</h3>
                        <p class="text-gray-600 text-sm">Tailored recommendations based on your financial profile</p>
                    </div>
                </div>

                <!-- Technology stack -->
                <div class="text-blue-100 text-sm">
                    <span class="font-semibold">Powered by:</span> Anthropic Claude AI • Spring Boot • OAuth2 Security
                </div>
            </div>

            <!-- Right Side - Login Form -->
            <div class="flex justify-center lg:justify-end">
                <div class="glass-effect rounded-2xl p-8 w-full max-w-md shadow-2xl">
                    <div class="text-center mb-8">
                        <div class="w-16 h-16 viom-logo-bg rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg pulse-animation">
                            <!-- Logo will show as background image -->
                        </div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">Welcome Back</h2>
                        <p class="text-gray-600">Sign in to access your Conversation Banking</p>
                    </div>

                    <!-- Login Section -->
                    <div id="loginSection" class="space-y-6">
                        <div id="errorMessage" class="hidden bg-red-50 border border-red-200 text-red-700 p-4 rounded-lg text-sm">
                            <div class="flex items-center">
                                <i class="fas fa-exclamation-triangle mr-2"></i>
                                <span id="errorText"></span>
                            </div>
                        </div>

                        <button
                                id="oauthLoginButton"
                                class="w-full bg-gradient-to-r from-blue-600 to-cyan-600 text-white font-semibold py-4 px-6 rounded-xl hover:from-blue-700 hover:to-cyan-700 transition duration-300 flex items-center justify-center space-x-3 shadow-lg transform hover:scale-105"
                        >
                            <i class="fas fa-shield-alt text-xl"></i>
                            <span class="text-lg">Secure Login with OAuth2</span>
                        </button>

                        <!-- Security notice -->
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="flex items-start space-x-3">
                                <i class="fas fa-info-circle text-blue-600 mt-1"></i>
                                <div class="text-sm text-blue-800">
                                    <div class="font-semibold mb-1">Secure Authentication</div>
                                    <div>Your login is protected by OAuth2 with PKCE security standards. We never store your credentials.</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Loading Section -->
                    <div id="loadingSection" class="hidden space-y-6">
                        <div class="text-center">
                            <div class="loading-spinner mx-auto mb-4"></div>
                            <p class="text-gray-600 font-medium">Authenticating securely...</p>
                            <p class="text-gray-500 text-sm mt-2">Please wait while we verify your credentials</p>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="mt-8 pt-6 border-t border-gray-200">
                        <div class="text-center">
                            <div class="text-sm text-gray-600 mb-2">
                                <i class="fas fa-code mr-1"></i>
                                Developed by <a href="https://www.viom.tech" target="_blank" class="font-semibold text-blue-600 hover:text-blue-800 transition duration-200">Viom Tech</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Background decorative elements -->
<div class="fixed inset-0 overflow-hidden pointer-events-none">
    <div class="absolute top-1/4 left-1/4 w-64 h-64 bg-white opacity-5 rounded-full"></div>
    <div class="absolute bottom-1/4 right-1/4 w-96 h-96 bg-cyan-300 opacity-5 rounded-full"></div>
    <div class="absolute top-3/4 left-1/3 w-32 h-32 bg-blue-300 opacity-10 rounded-full"></div>
</div>

<script>
    const API_BASE = '/api';

    // OAuth configuration
    const OAUTH_CONFIG = {
        serverUrl: '[[${oauthServerUrl}]]',
        clientId: 'client',
        clientSecret: 'secret',
        authorizationEndpoint: '/oauth2/authorize',
        tokenEndpoint: '/oauth2/token',
        redirectUri: `${window.location.origin}`,
        responseType: 'code',
        grantType: 'authorization_code',
        scope: 'read write',
        codeChallengeMethod: 'S256'
    };

    // Initialize the application
    document.addEventListener('DOMContentLoaded', function() {
        initializeApp();
    });

    function initializeApp() {
        // Check if we're returning from OAuth authorization
        const urlParams = new URLSearchParams(window.location.search);
        const authCode = urlParams.get('code');
        const state = urlParams.get('state');
        const error = urlParams.get('error');

        if (error) {
            showError(`OAuth error: ${error}`);
            cleanupUrl();
            return;
        }

        if (authCode) {
            // We have an authorization code, exchange it for a token
            handleAuthorizationCallback(authCode, state);
            return;
        }

        // Check if user is already logged in
        const currentUser = localStorage.getItem('currentUser');
        const jwtToken = localStorage.getItem('jwtToken');

        if (currentUser && jwtToken && !isTokenExpired(jwtToken)) {
            // User is already logged in with valid token
            window.location.href = '/chat';
            return;
        }

        // Clean up any expired tokens
        if (currentUser || jwtToken) {
            clearAuthData();
        }

        // Set up OAuth login button
        setupOAuthLogin();
    }

    function setupOAuthLogin() {
        document.getElementById('oauthLoginButton').addEventListener('click', startOAuthFlow);
    }

    function startOAuthFlow() {
        // Generate state parameter for CSRF protection
        const state = generateRandomString(32);
        localStorage.setItem('oauth_state', state);

        // Generate PKCE parameters
        const codeVerifier = generateCodeVerifier();

        // Store code verifier for later use in token exchange
        localStorage.setItem('code_verifier', codeVerifier);

        // Generate code challenge (this is async due to crypto.subtle)
        generateCodeChallenge(codeVerifier).then(codeChallenge => {
            // Build authorization URL with PKCE
            const authParams = new URLSearchParams({
                response_type: OAUTH_CONFIG.responseType,
                client_id: OAUTH_CONFIG.clientId,
                redirect_uri: OAUTH_CONFIG.redirectUri,
                scope: OAUTH_CONFIG.scope,
                state: state,
                code_challenge: codeChallenge,
                code_challenge_method: OAUTH_CONFIG.codeChallengeMethod
            });

            // Redirect to OAuth authorization server
            window.location.href = `${OAUTH_CONFIG.serverUrl}${OAUTH_CONFIG.authorizationEndpoint}?${authParams}`;
        }).catch(error => {
            console.error('Failed to generate PKCE challenge:', error);
            showError('Failed to initiate OAuth flow. Please try again.');
        });
    }

    async function handleAuthorizationCallback(authCode, state) {
        showLoadingSection();

        try {
            // Verify state parameter to prevent CSRF attacks
            const storedState = localStorage.getItem('oauth_state');
            if (!state || state !== storedState) {
                throw new Error('Invalid state parameter - possible CSRF attack');
            }

            // Clean up state
            localStorage.removeItem('oauth_state');

            // Exchange authorization code for access token
            const jwtToken = await exchangeCodeForToken(authCode);

            if (!jwtToken) {
                throw new Error('Failed to obtain access token');
            }

            // Extract username from JWT token
            const username = extractUsernameFromToken(jwtToken);
            if (!username) {
                throw new Error('Could not extract username from token');
            }

            // Login to our application with the JWT token
            const sessionData = await loginWithJWT(jwtToken);

            // Store session data
            localStorage.setItem('currentUser', JSON.stringify(sessionData));
            localStorage.setItem('jwtToken', jwtToken);

            // Clean up URL and redirect to chat
            cleanupUrl();
            window.location.href = '/chat';

        } catch (error) {
            console.error('OAuth callback error:', error);
            showError(error.message || 'Authentication failed. Please try again.');
            cleanupUrl();
            showLoginSection();
        }
    }

    async function exchangeCodeForToken(authCode) {
        try {
            // Get the stored code verifier for PKCE
            const codeVerifier = localStorage.getItem('code_verifier');
            if (!codeVerifier) {
                throw new Error('Code verifier not found - possible session issue');
            }

            // Clean up stored code verifier
            localStorage.removeItem('code_verifier');

            // Prepare token exchange request with PKCE
            const tokenRequest = new URLSearchParams({
                grant_type: OAUTH_CONFIG.grantType,
                code: authCode,
                redirect_uri: OAUTH_CONFIG.redirectUri,
                code_verifier: codeVerifier,
                client_secret: OAUTH_CONFIG.clientSecret,
            });

            // Add client secret if it's a confidential client
            if (OAUTH_CONFIG.clientSecret && OAUTH_CONFIG.clientSecret !== 'secret') {
                tokenRequest.append('client_secret', OAUTH_CONFIG.clientSecret);
            }
            const credentials = btoa(`${OAUTH_CONFIG.clientId}:${OAUTH_CONFIG.clientSecret}`);
            const response = await fetch(`${OAUTH_CONFIG.serverUrl}${OAUTH_CONFIG.tokenEndpoint}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'Accept': 'application/json',
                    'Authorization': `Basic ${credentials}`
                },
                body: tokenRequest.toString()
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                let errorMessage = 'Token exchange failed';

                if (response.status === 400) {
                    errorMessage = errorData.error_description || errorData.error || 'Invalid authorization code or PKCE verification failed';
                } else if (response.status === 401) {
                    errorMessage = 'Invalid client credentials';
                } else {
                    errorMessage = `OAuth server error: ${response.status}`;
                }

                throw new Error(errorMessage);
            }

            const tokenData = await response.json();

            if (!tokenData.access_token) {
                throw new Error('No access token received');
            }

            return tokenData.access_token;

        } catch (error) {
            console.error('Token exchange error:', error);
            if (error.message.includes('Failed to fetch')) {
                throw new Error('Unable to connect to OAuth server. Please check your connection.');
            }
            throw error;
        }
    }

    async function loginWithJWT(jwtToken) {
        try {
            const response = await fetch(`${API_BASE}/auth/login`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${jwtToken}`
                },
                body: JSON.stringify({})
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                let errorMessage = 'Login failed';

                if (response.status === 401) {
                    errorMessage = 'Invalid or expired token';
                } else if (response.status === 400) {
                    errorMessage = errorData.message || 'Invalid login request';
                } else {
                    errorMessage = `Server error: ${response.status}`;
                }

                throw new Error(errorMessage);
            }

            const sessionData = await response.json();

            // Store session data for chat initialization
            localStorage.setItem('customerSession', JSON.stringify(sessionData));
            localStorage.setItem('sessionTimestamp', Date.now().toString());

            return sessionData;

        } catch (error) {
            console.error('Application login error:', error);
            if (error.message.includes('Failed to fetch')) {
                throw new Error('Unable to connect to application server.');
            }
            throw error;
        }
    }

    function extractUsernameFromToken(token) {
        try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            // Try different common username claims
            return payload.sub || payload.username || payload.preferred_username || payload.user_name;
        } catch (error) {
            console.error('Failed to extract username from token:', error);
            return null;
        }
    }

    function isTokenExpired(token) {
        try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            const currentTime = Math.floor(Date.now() / 1000);
            return payload.exp && payload.exp <= currentTime;
        } catch (error) {
            return true;
        }
    }

    function generateRandomString(length) {
        const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        let result = '';
        for (let i = 0; i < length; i++) {
            result += characters.charAt(Math.floor(Math.random() * characters.length));
        }
        return result;
    }

    // PKCE helper functions
    function generateCodeVerifier() {
        // Generate a cryptographically random code verifier (43-128 characters)
        const array = new Uint8Array(32);
        crypto.getRandomValues(array);
        return base64URLEncode(array);
    }

    function generateCodeChallenge(codeVerifier) {
        // Create SHA256 hash of the code verifier
        return crypto.subtle.digest('SHA-256', new TextEncoder().encode(codeVerifier))
            .then(hashBuffer => {
                return base64URLEncode(new Uint8Array(hashBuffer));
            });
    }

    function base64URLEncode(array) {
        // Convert array to base64url encoding (RFC 4648)
        return btoa(String.fromCharCode.apply(null, array))
            .replace(/\+/g, '-')
            .replace(/\//g, '_')
            .replace(/=/g, '');
    }

    function cleanupUrl() {
        // Remove OAuth parameters from URL without causing a page reload
        const url = new URL(window.location);
        url.search = '';
        window.history.replaceState({}, document.title, url.toString());
    }

    function clearAuthData() {
        localStorage.removeItem('currentUser');
        localStorage.removeItem('jwtToken');
        localStorage.removeItem('oauth_state');
        localStorage.removeItem('code_verifier');
        // Clear session cache
        localStorage.removeItem('customerSession');
        localStorage.removeItem('sessionTimestamp');
    }

    function showLoadingSection() {
        document.getElementById('loginSection').classList.add('hidden');
        document.getElementById('loadingSection').classList.remove('hidden');
    }

    function showLoginSection() {
        document.getElementById('loadingSection').classList.add('hidden');
        document.getElementById('loginSection').classList.remove('hidden');
    }

    function showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        errorText.textContent = message;
        errorDiv.classList.remove('hidden');
    }

    function hideError() {
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.classList.add('hidden');
    }
</script>
</body>
</html>